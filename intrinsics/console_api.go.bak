package intrinsics

import (
    "fmt"
    "github.com/eoscanada/eos-go"
    "github.com/wasmerio/go-ext-wasm/wasmer"
    "unsafe"
)

// #include <stdlib.h>
//
// extern void prints(void *context, int32_t str);
// extern void prints_l(void *context, int32_t str, int32_t str_len);
// extern void printi(void *context, int64_t val);
// extern void printui(void *context, int64_t val);
// extern void printi128(void *context, int32_t val);
// extern void printui128(void *context, int32_t val);
// extern void printsf(void *context, float val);
// extern void printdf(void *context, double val);
// extern void printqf(void *context, int32_t val);
// extern void printn(void *context, int64_t value);
// extern void printhex(void *context, int32_t data, int32_t data_len);
import "C"

func init() {
    intrinsicsImports.Append("prints", prints, C.prints)
    intrinsicsImports.Append("prints_l", prints_l, C.prints_l)
    intrinsicsImports.Append("printi", printi, C.printi)
    intrinsicsImports.Append("printui", printui, C.printui)
    intrinsicsImports.Append("printi128", printi128, C.printi128)
    intrinsicsImports.Append("printui128", printui128, C.printui128)
    intrinsicsImports.Append("printsf", printsf, C.printsf)
    intrinsicsImports.Append("printdf", printdf, C.printdf)
    intrinsicsImports.Append("printqf", printqf, C.printqf)
    intrinsicsImports.Append("printn", printn, C.printn)
    intrinsicsImports.Append("printhex", printhex, C.printhex)
}

//export prints
func prints(context unsafe.Pointer, str int32) {
    value, err := ReadCStringAtOffset(GetMemoryFromContext(context), str)
    CheckError(err, "unable to read string")

    fmt.Print(value)
}

//export prints_l
func prints_l(context unsafe.Pointer, str int32, str_len int32) {
    instanceContext := wasmer.IntoInstanceContext(context)
    memory := instanceContext.Memory().Data()

    value, err := ReadMemoryRangeWithLength(memory, str, str_len)
    CheckError(err, "unable to read string")

    fmt.Println(value)
}

//export printi
func printi(context unsafe.Pointer, val int64) {
    fmt.Print(val)
}

//export printui
func printui(context unsafe.Pointer, val int64) {
    fmt.Print(uint64(val))
}

//export printi128
func printi128(context unsafe.Pointer, val int32) {
    fmt.Println("Called printi128")
    return
}

//export printui128
func printui128(context unsafe.Pointer, val int32) {
    fmt.Println("Called printui128")
    return
}

//export printsf
func printsf(context unsafe.Pointer, val float32) {
    fmt.Println("Called printsf")
    return
}

//export printdf
func printdf(context unsafe.Pointer, val float64) {
    fmt.Println("Called printdf")
    return
}

//export printqf
func printqf(context unsafe.Pointer, val int32) {
    fmt.Println("Called printqf")
    return
}

//export printn
func printn(context unsafe.Pointer, value int64) {
    fmt.Print(eos.NameToString(uint64(value)))
}

//export printhex
func printhex(context unsafe.Pointer, data int32, data_len int32) {
    fmt.Println("Called printhex")
    return
}

